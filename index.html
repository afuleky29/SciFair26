<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roboflow Plant Classifier</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitcount+Single:wght@100..900&display=swap" rel="stylesheet">
<style>
:root {
  --green: #2e7d32;
  --light-green: #e8f5e9;
}

body {
  margin: 0;
  font-family: "SF Pro Rounded", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--light-green);
  color: #222;
  display: flex;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: 700px;
  padding: 20px;
}

.card {
  background: white;
  border-radius: 18px;
  padding: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

h1 {
  text-align: center;
  color: var(--green);
  margin-bottom: 24px;
}

.section {
  margin-bottom: 20px;
}

select,
input[type="text"],
input[type="file"] {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 12px;
  font-size: 15px;
}

button {
  padding: 12px 18px;
  border: none;
  border-radius: 14px;
  background: var(--green);
  color: white;
  font-size: 15px;
  cursor: pointer;
  margin: 6px 6px 0 0;
}

button.secondary {
  background: #558b2f;
}

button.danger {
  background: #c62828;
}

video, img {
  width: 100%;
  max-height: 360px;
  border-radius: 16px;
  margin-top: 12px;
  display: none;
  object-fit: cover;
}

pre {
  background: #f1f1f1;
  padding: 14px;
  border-radius: 14px;
  overflow-x: auto;
  margin-top: 14px;
  font-size: 13px;
  display: none;
}

label.toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  cursor: pointer;
}

/* ðŸ”µ THINKING STATE */
#humanOutput.loading {
  opacity: 0.7;
  font-style: italic;
}
  
.bitcount-single-robofont {
  font-family: "Bitcount Single", system-ui;
  font-optical-sizing: auto;
  font-weight: 300;
  font-style: normal;
  font-variation-settings:
    "slnt" 0,
    "CRSV" 0.5,
    "ELSH" 0,
    "ELXP" 0;
}
</style>
</head>

<body>

<div class="container">
  <div class="card">

    <h1 class=bitcount-single-robofont>ðŸŒ± Plant Classifier</h1>

    <!-- MODE SELECT -->
    <div class="section">
      <select id="modeSelect" onchange="switchMode()">
        <option value="url">Image URL</option>
        <option value="file">File Upload</option>
        <option value="camera">Webcam</option>
      </select>
    </div>

    <!-- URL MODE -->
    <div class="section" id="urlSection">
      <input id="imageUrl" placeholder="Paste image URL">
    </div>

    <!-- FILE MODE -->
    <div class="section" id="fileSection" style="display:none;">
      <input type="file" id="filePicker" accept="image/*">
    </div>

    <!-- CAMERA MODE -->
    <div class="section" id="cameraSection" style="display:none;">
      <button onclick="startCamera()">Start Capturing</button>
      <button class="secondary" onclick="flipCamera()">Flip Camera</button>
      <button class="danger" onclick="stopCamera()">Stop Camera</button>
    </div>

    <!-- RUN -->
    <div class="section">
      <button onclick="runSelected()">Run</button>
    </div>

    <!-- JSON TOGGLE -->
    <div class="section">
      <label class="toggle">
        <input type="checkbox" id="jsonToggle" onchange="toggleJSON()">
        Show raw JSON response
      </label>
    </div>

    <video id="webcam" autoplay playsinline></video>
    <img id="preview">
<br>
    <!-- HUMAN OUTPUT -->
    <div id="humanOutput"></div>

    <!-- RAW JSON -->
    <pre id="jsonOutput"></pre>

  </div>
</div>

<script>
const BACKEND_URL = "https://scifair-backend.onrender.com";
const CONFIDENCE_THRESHOLD = 0.95;

const webcam = document.getElementById("webcam");
const preview = document.getElementById("preview");
const modeSelect = document.getElementById("modeSelect");
const humanOutput = document.getElementById("humanOutput");
const jsonOutput = document.getElementById("jsonOutput");
const jsonToggle = document.getElementById("jsonToggle");

let stream = null;
let cameraFacing = "environment";

/* ---------- THINKING ---------- */
function showThinking() {
  humanOutput.textContent = "ðŸ¤” Iâ€™m thinkingâ€¦";
  humanOutput.classList.add("loading");
}

/* ---------- MODE SWITCH ---------- */
function switchMode() {
  stopCamera();

  urlSection.style.display = "none";
  fileSection.style.display = "none";
  cameraSection.style.display = "none";

  preview.style.display = "none";
  webcam.style.display = "none";
  humanOutput.textContent = "";
  jsonOutput.style.display = "none";

  if (modeSelect.value === "url") urlSection.style.display = "block";
  if (modeSelect.value === "file") fileSection.style.display = "block";
  if (modeSelect.value === "camera") cameraSection.style.display = "block";
}

/* ---------- RUN ---------- */
function runSelected() {
  if (modeSelect.value === "url") runURL();
  else if (modeSelect.value === "file") runFile();
  else captureWebcam();
}

/* ---------- URL ---------- */
function runURL() {
  const url = imageUrl.value.trim();
  if (!url) return alert("Enter an image URL");

  preview.src = url;
  preview.style.display = "block";

  showThinking();
  sendJSON({ url });
}

/* ---------- FILE ---------- */
async function runFile() {
  const file = filePicker.files[0];
  if (!file) return alert("Choose an image");

  const fd = new FormData();
  fd.append("file", file);

  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";

  showThinking();
  const res = await fetch(BACKEND_URL, { method: "POST", body: fd });
  handleResponse(res);
}

/* ---------- CAMERA ---------- */
async function startCamera() {
  stopCamera();
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: cameraFacing } });
  webcam.srcObject = stream;
  webcam.style.display = "block";
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  webcam.style.display = "none";
}

function flipCamera() {
  cameraFacing = cameraFacing === "user" ? "environment" : "user";
  startCamera();
}

function captureWebcam() {
  if (!stream) return alert("Start the camera first");

  const canvas = document.createElement("canvas");
  canvas.width = webcam.videoWidth;
  canvas.height = webcam.videoHeight;
  canvas.getContext("2d").drawImage(webcam, 0, 0);

  const base64 = canvas.toDataURL("image/jpeg");
  preview.src = base64;
  preview.style.display = "block";

  showThinking();
  sendJSON({ base64 });
}

/* ---------- BACKEND ---------- */
async function sendJSON(data) {
  const res = await fetch(BACKEND_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  handleResponse(res);
}

/* ---------- RESPONSE HANDLING ---------- */
async function handleResponse(res) {
  humanOutput.classList.remove("loading");

  const json = await res.json();

  jsonOutput.textContent = JSON.stringify(json, null, 2);
  jsonOutput.style.display = jsonToggle.checked ? "block" : "none";

  if (!json.outputs) {
    humanOutput.textContent = "Unexpected response from model.";
    return;
  }

  const predictions =
    json.outputs[0]?.predictions?.predictions || [];

  if (!predictions.length) {
    humanOutput.textContent = "I'm not sure what plant this is.";
    return;
  }

  const top = predictions[0];
  const label = top.class || top.label || "Unknown";
  const confidence = top.confidence ?? 0;

  if (confidence >= CONFIDENCE_THRESHOLD) {
    humanOutput.textContent =
      `ðŸŒ± Iâ€™m confident this is ${label} (${(confidence * 100).toFixed(1)}%)`;
  } else {
    humanOutput.textContent =
      `ðŸ¤” I think this is ${label}, but please double-check ` +
      `(${(confidence * 100).toFixed(1)}%)`;
  }
}

function toggleJSON() {
  jsonOutput.style.display = jsonToggle.checked ? "block" : "none";
}
</script>

</body>
</html>
